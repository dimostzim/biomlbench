# Spatially Variable Genes Task

## Overview
Spatially variable genes (SVGs) are genes whose expression levels vary significantly across different spatial regions within a tissue or across cells in a spatially structured context.

## Task Description
Recent years have witnessed significant progress in spatially-resolved transcriptome profiling techniques that simultaneously characterize cellular gene expression and their physical position, generating spatial transcriptomic (ST) data. The application of these techniques has dramatically advanced our understanding of disease and developmental biology. One common task for all ST profiles, regardless of the employed protocols, is to identify genes that exhibit spatial patterns. These genes, defined as spatially variable genes (SVGs), contain additional information about the spatial structure of the tissues of interest, compared to highly variable genes (HVGs).

Identification of spatially variable genes is crucial to for studying spatial domains within tissue microenvironmnets, developmental gradients and cell signaling pathways. In this task we attempt to evaluate various methods for detecting SVGs using a number of realistic simulated datasets with diverse patterns derived from real-world spatial transcriptomics data using scDesign3. Synthetic data is generated by mixing a Gaussian Process (GP) model and a non-spatial model (obtained by shuffling mean parameters of the GP model to remove spatial correlation between spots) to generate gene expressions with various spatial variability. For more details, please refer to our [manuscript](https://www.biorxiv.org/content/10.1101/2023.12.02.569717v1) and [Github](https://github.com/pinellolab/SVG_Benchmarking).


## Dataset: Mouse Cortex (SlideSeqV2)
This task uses spatial transcriptomics data from mouse cortex captured using SlideSeqV2 technology. The dataset includes:

- **Technology**: SlideSeqV2
- **Organism**: Mouse
- **Tissue**: Cortex
- **Number of genes evaluated**: 210 genes
- **Spatial pattern generation**: Gaussian Process (GP) based synthetic patterns

The dataset contains a mix of:
- Genes with true spatial variability (score = 1.0)
- Genes without spatial patterns (score = 0.0)

Note: While the ground truth scores in this dataset are binary (0.0 or 1.0), the task requires predicting continuous spatial variability scores that will be evaluated using correlation metrics.

## Data Format
All data is provided in H5AD (AnnData) format:

- `dataset.h5ad`: Training data containing gene expression and spatial coordinates
  - Expression matrix in `.X`
  - Spatial coordinates in `.obsm['spatial']`
  - Gene information in `.var` (with anonymized gene identifiers GENE1, GENE2, etc.)
  
- `solution.h5ad`: Ground truth labels
  - True spatial variability scores in `.var['true_spatial_var_score']`
  - Continuous scores: ranging from 0.0 to 1.0, where higher values indicate stronger spatial variability

## Evaluation Metric
The task uses **Kendall's tau correlation coefficient** to evaluate the performance of spatially variable gene detection methods. This non-parametric correlation metric measures the ordinal association between predicted and true spatial variability scores, making it robust to outliers and appropriate for ranking-based evaluations.

## Input/Output Specification

### Input
Agents receive:
- `train.h5ad`: Spatial transcriptomics data (mouse cortex) with:
  - Gene expression matrix
  - Spatial coordinates for each spot/cell
  - Gene metadata (anonymized as GENE1, GENE2, etc.)
- `cerebellum_train.h5ad`: Additional spatial transcriptomics data (mouse cerebellum) for method validation
- `cerebellum_labels.h5ad`: Ground truth labels for the cerebellum dataset to test your method before submission

Note: All gene names have been anonymized to prevent information leakage. Genes are consistently named across all datasets (e.g., GENE1 in cortex data corresponds to GENE1 in cerebellum data).

### Output
Agents must produce a CSV file (`submission.csv`) with:
- `gene_id`: Gene identifier (GENE1, GENE2, etc., matching the anonymized names in the training data)
- `spatial_score`: Continuous score indicating the degree of spatial variability (0.0-1.0)
  - Higher scores indicate stronger spatial variability
  - Scores will be correlated with true spatial variability scores using Kendall's tau

### Sample Submission Format
```csv
gene_id,spatial_score
GENE1,0.123
GENE2,0.456
GENE3,0.789
...
```


Available files:
- `dataset.h5ad`: Training data
- `solution.h5ad`: Ground truth labels
- `simulated_dataset.h5ad`: (Not used - combination of dataset and labels)
- `state.yaml`: Dataset metadata

# A Primer on Spatial Variability

Spatial transcriptomics enables the measurement of gene expression and positional information in tissues. The evolution of spatial transcriptomics technologies advanced the reconstruction of tissue structure and provided profound insights into developmental biology, physiology, cancer, and other fields. However, the complexity and high dimensionality of spatial transcriptomics (ST) data pose new challenges and requirements for analytical approaches. One crucial analytical challenge in spatial transcriptomics studies is the identification of spatially variable genes (SVGs) whose expressions correlate with spatial location, also known as SE genes (genes with spatial expression patterns). Identifying SVGs promotes characterizing spatial patterns within tissues and predicting spatial domains. Several methods have been developed for detecting SVGs. Trendsceek models the data as marked point processes and tests the significant dependency between spatial distributions and expression levels of pairwise points. SpatialDE decomposes gene expression variability into a spatial component and an independent noise term based on Gaussian process regression and tests statistical significance by comparing the SpatialDE model to a null model without the spatial variance component. SPARK, an extension of SpatialDE, uses the Gaussian process regression as the underlying data model and ten different spatial kernels to represent common spatial patterns in biological data, thereby improving statistical power. SPARK-X tests the dependence of gene expressions and spatial locations based on the covariance test framework. scGCO applies graph cuts in computer vision to address SVG identification. It utilizes the hidden Markov random field to identify candidate regions with spatial dependence for individual genes and tests their dependence under the complete spatial randomness framework. Squidpy uses Moran's I to determine SVG and calculates the p-value based on standard normal approximation from 100 random permutations.

Trendsceek, SpatialDE, and SPARK have limited applicability for large-scale datasets due to their high computational complexity. Trendsceek employs the permutation strategy to compute multiple statistics of different paired points, which requires extensive computational work and is only scalable to small-scale datasets. The Gaussian process framework hinders the detection of SVGs and model parameter convergence in SpatialDE and SPARK when analyzing high-dimensional and sparse ST data. SPARK-X offers significantly faster computational speed than the aforementioned methods, but its effectiveness depends heavily on how well the constructed spatial covariance matrix matches the true underlying spatial patterns. The above four methods identify SVGs by searching for predefined relationships between expressions and locations. They have limited generalizability to a wide range of spatial patterns due to the arbitrary nature of the true spatial pattern of SVGs and the resulting uncertainty in the relationship between expression and coordinates. scGCO has the capability to identify SVGs with unknown exact locations and shapes, however, it suffers from false negatives due to the limited accuracy of the graph cuts algorithm in identifying candidate regions for SVGs, especially in sparse ST datasets. The accuracy of Squidpy depends on the number of random permutations. Increasing the number of random permutations enhances the reliability of the results; however, it comes at the cost of increased time consumption, making the process more time-intensive.

Here is an example of one method:

It simulates a diffusion process and evaluates the time it takes to reach a uniform state (convergence). It is a formulation of Fick’s second law to a regular graph (grid). It is defined as:

u\left( {x,y,t + dt} \right) = u\left( {x,y,t} \right) + D{\Delta}u\left( {x,y,t} \right)dt

Where u(x,y,t) is the concentration (for example gene expression on a node in x,y coordinates), D is the diffusion coefficient, t is the update time and ∆(u(x,y,t)dt) is the laplacian on the graph (see elsewhere42 for an extended formulation). Convergence is reached if the change in entropy is below a given threshold:

H\left( {u\left( t \right)} \right) - H\left( {u\left( {t - 1} \right)} \right) < {\it{\epsilon }}

The time t the gene takes to reach consensus is then used a ‘Sepal score’ and indicates the degree of spatial variability of the gene. 

Your role in this task is to build a novel method for detecting SVGs OR utilize an existing method if you think it is the best. Keep in mind that existing methods will probably not beat the leaderboard alone as it is comprised of existing methods.

